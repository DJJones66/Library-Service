You are an autonomous coding agent.
Use the $prd skill to create a Product Requirements Document in JSON.
Save the PRD as JSON in directory: /home/hacker/Projects/Library-Service/.agents/tasks
Filename rules: prd-<short-slug>.json using 1-3 meaningful words.
Examples: prd-workout-tracker.json, prd-usage-billing.json
The request is fully specified in the provided file. Do not ask clarifying questions; generate the PRD directly.
Do NOT implement anything.
After creating the PRD, end with:
PRD JSON saved to <path>. Close this chat and run `braindrive-forge build`.

User request:
Perfect — here’s a **clean, execution-ready `build-plan.md`** for the **BrainDrive Markdown MCP Server**.

This is written to be:

* **Hand-off ready** (you could give this to an engineer or agent)
* **Testable** (every phase has verifiable success criteria)
* **Strictly scoped** (no Library creep, no agent logic)

You can drop this directly next to the spec.

---

# BrainDrive Markdown MCP

**Build Plan**

> **File:** `build-plan.md`
> **Applies to:** BrainDrive Markdown MCP Server
> **Spec Version:** v0.3
> **Status:** Approved for Implementation

---

## 1. Objective

Implement a **deterministic, secure, auditable MCP server** that is the **single authoritative execution layer** for all markdown operations inside a BrainDrive Library.

At completion:

* No component writes markdown directly
* Every markdown mutation is previewable, approved, logged, and reversible
* The Library is safe to expose to AI agents and external tools

---

## 2. Guiding Constraints (Non-Negotiable)

These apply to **every phase**:

* ❌ No intent detection
* ❌ No autonomous edits
* ❌ No shell access
* ❌ No access outside `BRAINDRIVE_LIBRARY_PATH`
* ❌ No non-markdown writes
* ✅ Deterministic execution only
* ✅ One git commit per operation
* ✅ Fail safely (no partial writes)

---

## 3. Implementation Phases

---

## Phase 1 — MCP Skeleton & Safety Envelope

**Goal:**
Create a running MCP server with **hard security boundaries** and no file mutation capability yet.

### Deliverables

* MCP server bootstrapped
* Library root enforcement
* Path validation utilities
* Structured error handling

### Tasks

* Initialize MCP service (FastAPI or equivalent)
* Load `BRAINDRIVE_LIBRARY_PATH` from config
* Implement path normalization + validation
* Reject:

  * Absolute paths
  * `..` traversal
  * Symlinks
* Add structured error responses
* Add basic health check endpoint

### Success Criteria

* Server starts successfully
* Invalid paths are rejected deterministically
* No filesystem access occurs outside Library root
* Server can run fully offline

### Verification

```bash
# Attempt path traversal
read_markdown("../../etc/passwd") → ERROR

# Attempt absolute path
read_markdown("/home/user/file.md") → ERROR
```

---

## Phase 2 — Read-Only Markdown Operations

**Goal:**
Safely expose markdown read, list, and search operations.

### Deliverables

* `read_markdown`
* `list_markdown_files`
* `search_markdown`

### Tasks

* Implement markdown file read
* Return file metadata (size, last modified, git HEAD)
* Implement recursive directory listing
* Implement simple text search (no embeddings)
* Ensure all outputs are JSON-serializable

### Success Criteria

* Markdown content can be read reliably
* Searches return accurate file paths + snippets
* No writes occur under any circumstance

### Verification

```bash
read_markdown("projects/active/foo/spec.md") → content returned
search_markdown("JWT") → correct file hits
```

---

## Phase 3 — Diff Generation & Preview Engine

**Goal:**
Generate **accurate, human-readable diffs** without mutating files.

### Deliverables

* `preview_markdown_change`
* Unified diff output
* Risk classification stub

### Tasks

* Implement in-memory markdown edit simulation
* Generate unified diff against current file
* Return summary + risk hint (`low | medium | high`)
* Ensure preview never writes to disk

### Success Criteria

* Preview matches eventual write exactly
* Diff output is copy-pasteable
* No filesystem writes occur

### Verification

```bash
preview_markdown_change → diff shown
File unchanged on disk
```

---

## Phase 4 — Write & Edit Operations (Single-File)

**Goal:**
Enable controlled, explicit markdown mutation.

### Deliverables

* `write_markdown`
* `edit_markdown`
* Section-aware operations

### Supported Operations

* `append`
* `prepend`
* `replace_section`
* `insert_before`
* `insert_after`

### Tasks

* Implement atomic file writes
* Validate target section existence
* Fail safely if target not found
* Ensure newline consistency
* Enforce markdown-only writes

### Success Criteria

* Exact edits applied as previewed
* Invalid targets fail without side effects
* No partial file corruption

### Verification

```bash
replace_section("## Scope") → success
replace_section("## Missing") → ERROR, no change
```

---

## Phase 5 — Delete Operations (Safe & Explicit)

**Goal:**
Support markdown deletion with maximum safety.

### Deliverables

* `delete_markdown`

### Tasks

* Require explicit confirmation flag
* Verify file exists and is markdown
* Delete single file only (no recursion)
* Ensure git rollback is possible

### Success Criteria

* Deletions are explicit
* Accidental deletes are impossible
* Git history retains file

### Verification

```bash
delete_markdown(path, confirm=false) → ERROR
delete_markdown(path, confirm=true) → success
```

---

## Phase 6 — Git Integration

**Goal:**
Ensure **every mutation is auditable and reversible**.

### Deliverables

* Automatic git commits
* Clean commit messages
* Commit metadata returned to caller

### Tasks

* Detect git repository or initialize if missing
* Stage only affected files
* Create one commit per operation
* Prevent commit squashing or rebasing

### Success Criteria

* Every write/edit/delete creates exactly one commit
* Commit messages are human-readable
* Git SHA returned in response

### Verification

```bash
git log → shows individual operations
```

---

## Phase 7 — Activity Logging

**Goal:**
Produce an immutable, queryable action log.

### Deliverables

* Structured activity log events
* Timestamped entries
* Operation summaries

### Tasks

* Emit log entry per successful operation
* Store log in append-only format
* Include:

  * Operation type
  * Path
  * Summary
  * Git commit SHA

### Success Criteria

* Log reflects all actions accurately
* No missing or duplicate entries
* Logs survive restarts

---

## Phase 8 — MCP Contract Hardening

**Goal:**
Make the MCP **impossible to misuse**.

### Deliverables

* Strict input schemas
* Defensive validation
* Consistent error semantics

### Tasks

* Validate all inputs
* Reject unknown fields
* Normalize all responses
* Add exhaustive unit tests

### Success Criteria

* Invalid inputs never cause side effects
* MCP behavior is predictable
* Error messages are explicit and actionable

---

## Phase 9 — Integration Validation

**Goal:**
Confirm MCP works as the **only markdown executor**.

### Deliverables

* Library Plugin integration test
* Agent simulation tests
* External tool compatibility check

### Tasks

* Route all Library markdown ops through MCP
* Block direct filesystem writes
* Verify approval → preview → execute flow
* Test concurrent read + write safety

### Success Criteria

* No markdown writes bypass MCP
* Library Plugin functions fully
* External tools can read/write safely via MCP

---

## 4. Out-of-Scope (Confirmed)

The following are **explicitly excluded** from this build:

* Merge conflict resolution
* Batch multi-file edits
* Semantic section detection
* Task management
* Embeddings / RAG
* Background indexing
* Auto-approval logic

---

## 5. Definition of Done

The Markdown MCP is **DONE** when:

* [ ] All markdown ops go through MCP
* [ ] No unsafe file access is possible
* [ ] Every change produces a diff + commit
* [ ] All actions are logged
* [ ] MCP can be safely exposed to AI agents
* [ ] The Library remains portable and human-readable

> **If someone can delete or corrupt the Library without MCP approval, the build is not done.**


