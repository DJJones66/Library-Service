{
  "version": 1,
  "project": "BrainDrive Markdown MCP Server",
  "overview": "Implement a deterministic, secure, auditable MCP server that is the single execution layer for markdown operations within BRAINDRIVE_LIBRARY_PATH, with preview, approval, logging, and git-backed reversibility.",
  "goals": [
    "Provide MCP operations for reading, listing, searching, previewing, writing, editing, and deleting markdown",
    "Enforce a strict safety envelope: library-root only, markdown-only, deterministic execution",
    "Ensure every mutation is previewable, logged, and committed for audit and rollback",
    "Expose predictable schemas and error responses for tools and agents"
  ],
  "nonGoals": [
    "No intent detection or autonomous edits",
    "No shell access",
    "No access outside BRAINDRIVE_LIBRARY_PATH",
    "No non-markdown writes",
    "No merge conflict resolution",
    "No batch multi-file edits",
    "No semantic section detection",
    "No task management",
    "No embeddings or RAG",
    "No background indexing",
    "No auto-approval logic"
  ],
  "successMetrics": [
    "All markdown mutations go through the MCP and produce a diff, a git commit, and a log entry",
    "Path traversal and absolute path attempts are rejected deterministically",
    "Read-only operations never perform writes",
    "Each mutation results in exactly one git commit with a returned SHA",
    "Server runs offline with deterministic output"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "FastAPI (Python) with MCP protocol handlers",
    "hosting": "Self-hosted process or container",
    "database": "None (filesystem + git + append-only log)",
    "auth": "Out of scope; handled by surrounding system"
  },
  "routes": [
    {
      "path": "/health",
      "name": "Health Check",
      "purpose": "Liveness probe for the server"
    },
    {
      "path": "tool:read_markdown",
      "name": "read_markdown",
      "purpose": "Read markdown content and metadata within the library root"
    },
    {
      "path": "tool:list_markdown_files",
      "name": "list_markdown_files",
      "purpose": "List markdown files under the library root"
    },
    {
      "path": "tool:search_markdown",
      "name": "search_markdown",
      "purpose": "Search markdown text and return snippets"
    },
    {
      "path": "tool:preview_markdown_change",
      "name": "preview_markdown_change",
      "purpose": "Generate a unified diff preview without writing"
    },
    {
      "path": "tool:write_markdown",
      "name": "write_markdown",
      "purpose": "Create or append/prepend markdown content"
    },
    {
      "path": "tool:edit_markdown",
      "name": "edit_markdown",
      "purpose": "Section-aware markdown edits"
    },
    {
      "path": "tool:delete_markdown",
      "name": "delete_markdown",
      "purpose": "Delete a markdown file with explicit confirmation"
    }
  ],
  "uiNotes": [
    "No UI; JSON-only inputs and outputs",
    "Unified diff output is returned as a string payload",
    "Error responses include stable codes and actionable messages"
  ],
  "dataModel": [
    {
      "entity": "LibraryConfig",
      "fields": [
        "libraryRootPath",
        "allowedExtensions",
        "logPath"
      ]
    },
    {
      "entity": "MarkdownFileMetadata",
      "fields": [
        "path",
        "sizeBytes",
        "lastModified",
        "gitHead"
      ]
    },
    {
      "entity": "PreviewResult",
      "fields": [
        "diff",
        "summary",
        "riskLevel"
      ]
    },
    {
      "entity": "ActivityLogEntry",
      "fields": [
        "timestamp",
        "operation",
        "path",
        "summary",
        "commitSha"
      ]
    },
    {
      "entity": "ErrorResponse",
      "fields": [
        "code",
        "message",
        "details"
      ]
    }
  ],
  "importFormat": {
    "description": "Not applicable",
    "example": {}
  },
  "rules": [
    "Reject absolute paths, '..' traversal, and symlinks; resolve within BRAINDRIVE_LIBRARY_PATH",
    "Only read/write files with .md or .markdown extensions",
    "No shell access; all operations use in-process libraries",
    "Deterministic execution; same input yields same output",
    "Preview operations never write to disk",
    "All writes are atomic and fail-safe (no partial writes)",
    "One git commit per mutation and return the commit SHA",
    "Every successful mutation appends a log entry",
    "No access outside the library root"
  ],
  "qualityGates": [
    "python -m pytest",
    "python -m ruff check ."
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Scaffold MCP server with config and health endpoint",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want a bootstrapped MCP server with configuration loading so that the service can start locally and enforce required setup.",
      "acceptanceCriteria": [
        "Project scaffold includes a FastAPI app entrypoint and MCP handler module",
        "Dependency install command documented and works: `pip install fastapi uvicorn pytest ruff`",
        "Config loads BRAINDRIVE_LIBRARY_PATH from environment and exposes it to the app",
        "Local dev run command documented and works: `uvicorn app.main:app --reload`",
        "Health endpoint returns JSON with status ok and HTTP 200",
        "Example: GET /health returns {\"status\": \"ok\"}",
        "Negative case: starting without BRAINDRIVE_LIBRARY_PATH returns a clear config error and the server does not start"
      ],
      "startedAt": "2026-02-05T17:06:03.242665+00:00",
      "completedAt": "2026-02-05T17:21:05.457585+00:00",
      "updatedAt": "2026-02-05T17:21:05.457568+00:00"
    },
    {
      "id": "US-002",
      "title": "Implement safety envelope and path validation utilities",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want shared path validation and structured errors so that all operations enforce the library boundary deterministically.",
      "acceptanceCriteria": [
        "Path normalization rejects absolute paths, '..' traversal, and symlinks",
        "All tool inputs are validated against BRAINDRIVE_LIBRARY_PATH before any filesystem access",
        "Structured error responses include code, message, and details",
        "Example: validate_path(\"notes/spec.md\") returns a normalized path within the library root",
        "Negative case: validate_path(\"../../etc/passwd\") returns PATH_TRAVERSAL error without reading the filesystem"
      ],
      "startedAt": "2026-02-05T17:21:07.667378+00:00",
      "completedAt": "2026-02-05T17:35:02.518793+00:00",
      "updatedAt": "2026-02-05T17:35:02.518777+00:00"
    },
    {
      "id": "US-003",
      "title": "Add read_markdown operation with metadata",
      "status": "done",
      "dependsOn": [
        "US-002"
      ],
      "description": "As a user, I want to read markdown content and metadata so that tools can consume library documents safely.",
      "acceptanceCriteria": [
        "read_markdown returns file content and metadata (sizeBytes, lastModified, gitHead)",
        "Responses are JSON-serializable and deterministic",
        "Example: read_markdown(\"projects/active/foo/spec.md\") returns content and metadata",
        "Negative case: read_markdown(\"projects/active/foo/spec.txt\") returns NOT_MARKDOWN error and no writes occur"
      ],
      "startedAt": "2026-02-05T17:35:04.726502+00:00",
      "completedAt": "2026-02-05T17:44:34.134601+00:00",
      "updatedAt": "2026-02-05T17:44:34.134583+00:00"
    },
    {
      "id": "US-004",
      "title": "Add list_markdown_files operation",
      "status": "done",
      "dependsOn": [
        "US-002"
      ],
      "description": "As a user, I want to list markdown files recursively so that tools can discover library content.",
      "acceptanceCriteria": [
        "list_markdown_files returns a deterministic, sorted list of markdown paths",
        "Listing respects the library root and allowed extensions",
        "Example: list_markdown_files(\"projects\") returns only .md/.markdown files",
        "Negative case: list_markdown_files(\"../../\") returns PATH_TRAVERSAL error"
      ],
      "startedAt": "2026-02-05T17:44:36.335878+00:00",
      "completedAt": "2026-02-05T17:54:52.429305+00:00",
      "updatedAt": "2026-02-05T17:54:52.429285+00:00"
    },
    {
      "id": "US-005",
      "title": "Add search_markdown operation",
      "status": "done",
      "dependsOn": [
        "US-004"
      ],
      "description": "As a user, I want to search markdown text so that I can find relevant files without embeddings.",
      "acceptanceCriteria": [
        "search_markdown performs simple substring search and returns matching paths with snippets",
        "Search is deterministic and does not use embeddings",
        "Example: search_markdown(\"JWT\") returns correct file hits and snippets",
        "Negative case: search_markdown(\"\") returns INVALID_QUERY error"
      ],
      "startedAt": "2026-02-05T17:54:54.639212+00:00",
      "completedAt": "2026-02-05T18:02:53.705353+00:00",
      "updatedAt": "2026-02-05T18:02:53.705333+00:00"
    },
    {
      "id": "US-006",
      "title": "Add preview_markdown_change operation",
      "status": "done",
      "dependsOn": [
        "US-003"
      ],
      "description": "As a user, I want a diff preview for markdown edits so that changes are reviewable before any write.",
      "acceptanceCriteria": [
        "preview_markdown_change simulates edits in memory and returns unified diff, summary, and riskLevel",
        "Preview never writes to disk",
        "Example: preview append returns a diff and the file remains unchanged",
        "Negative case: preview on a non-markdown path returns NOT_MARKDOWN error and the file remains unchanged"
      ],
      "startedAt": "2026-02-05T18:02:55.905239+00:00",
      "completedAt": "2026-02-05T18:13:28.658985+00:00",
      "updatedAt": "2026-02-05T18:13:28.658970+00:00"
    },
    {
      "id": "US-007",
      "title": "Add write_markdown operation for append/prepend",
      "status": "done",
      "dependsOn": [
        "US-002"
      ],
      "description": "As a user, I want controlled single-file writes so that markdown can be updated safely and atomically.",
      "acceptanceCriteria": [
        "write_markdown supports append and prepend operations on markdown files",
        "Writes are atomic and preserve newline consistency",
        "Example: append adds content at the end of the file exactly as previewed",
        "Negative case: unsupported operation returns INVALID_OPERATION and leaves the file unchanged"
      ],
      "startedAt": "2026-02-05T18:13:30.868898+00:00",
      "completedAt": "2026-02-05T18:23:13.925574+00:00",
      "updatedAt": "2026-02-05T18:23:13.925561+00:00"
    },
    {
      "id": "US-008",
      "title": "Add edit_markdown section-aware operations",
      "status": "done",
      "dependsOn": [
        "US-007"
      ],
      "description": "As a user, I want section-aware edits so that targeted changes are reliable and reversible.",
      "acceptanceCriteria": [
        "edit_markdown supports replace_section, insert_before, and insert_after",
        "Target sections must exist; otherwise the operation fails safely",
        "Example: replace_section(\"## Scope\") updates only the targeted section",
        "Negative case: replace_section(\"## Missing\") returns SECTION_NOT_FOUND and leaves the file unchanged"
      ],
      "startedAt": "2026-02-05T18:23:16.135008+00:00",
      "completedAt": "2026-02-05T18:35:24.412967+00:00",
      "updatedAt": "2026-02-05T18:35:24.412949+00:00"
    },
    {
      "id": "US-009",
      "title": "Add delete_markdown with explicit confirmation",
      "status": "done",
      "dependsOn": [
        "US-002"
      ],
      "description": "As a user, I want explicit deletion safeguards so that accidental deletes are impossible.",
      "acceptanceCriteria": [
        "delete_markdown deletes a single markdown file only when confirm=true",
        "Deletion rejects directories and non-markdown paths",
        "Example: delete_markdown(path, confirm=true) removes the file",
        "Negative case: delete_markdown(path, confirm=false) returns CONFIRM_REQUIRED and the file remains"
      ],
      "startedAt": "2026-02-05T18:35:26.610541+00:00",
      "completedAt": "2026-02-05T18:43:10.115693+00:00",
      "updatedAt": "2026-02-05T18:43:10.115677+00:00"
    },
    {
      "id": "US-010",
      "title": "Integrate git commits for all mutations",
      "status": "done",
      "dependsOn": [
        "US-007",
        "US-008",
        "US-009"
      ],
      "description": "As a user, I want every mutation committed so that all changes are auditable and reversible.",
      "acceptanceCriteria": [
        "Git repository is detected or initialized within the library root",
        "Each write/edit/delete creates exactly one commit and returns the commit SHA",
        "Use a no-shell git library for operations; dependency install command documented: `pip install dulwich`",
        "Example: write_markdown produces a new commit and the response includes the SHA",
        "Negative case: if git initialization or commit fails, the mutation is rolled back and an error is returned"
      ],
      "startedAt": "2026-02-05T18:43:12.332028+00:00",
      "completedAt": "2026-02-05T18:57:50.011009+00:00",
      "updatedAt": "2026-02-05T18:57:50.010989+00:00"
    },
    {
      "id": "US-011",
      "title": "Add append-only activity logging",
      "status": "done",
      "dependsOn": [
        "US-010"
      ],
      "description": "As an operator, I want an immutable log of operations so that actions are auditable across restarts.",
      "acceptanceCriteria": [
        "Each successful mutation appends one structured log entry with timestamp, operation, path, summary, and commitSha",
        "Log is stored in an append-only format within the library root",
        "Example: a successful edit appends exactly one log entry tied to the commit SHA",
        "Negative case: if log write fails, the mutation is not committed and the file remains unchanged"
      ],
      "startedAt": "2026-02-05T18:57:52.221989+00:00",
      "completedAt": "2026-02-05T19:11:28.214837+00:00",
      "updatedAt": "2026-02-05T19:11:28.214819+00:00"
    },
    {
      "id": "US-012",
      "title": "Harden MCP contract with strict schemas and tests",
      "status": "done",
      "dependsOn": [
        "US-003",
        "US-004",
        "US-005",
        "US-006",
        "US-007",
        "US-008",
        "US-009",
        "US-010",
        "US-011"
      ],
      "description": "As a client, I want strict schemas and predictable errors so that tool usage is safe and deterministic.",
      "acceptanceCriteria": [
        "All tool inputs are validated against strict schemas and unknown fields are rejected",
        "All responses follow a consistent JSON shape with stable error codes",
        "Unit tests cover validation and error semantics for each tool",
        "Example: providing an extra field returns UNKNOWN_FIELD with no side effects",
        "Negative case: invalid type for path returns INVALID_TYPE and no filesystem access occurs"
      ],
      "startedAt": "2026-02-05T19:11:30.421270+00:00",
      "completedAt": "2026-02-05T19:28:39.825465+00:00",
      "updatedAt": "2026-02-05T19:28:39.825445+00:00"
    },
    {
      "id": "US-013",
      "title": "Integration validation for MCP-only markdown execution",
      "status": "done",
      "dependsOn": [
        "US-012"
      ],
      "description": "As a maintainer, I want integration validation so that all markdown operations flow through the MCP safely.",
      "acceptanceCriteria": [
        "Integration tests route all Library markdown operations through the MCP server",
        "Agent simulation tests verify preview -> approve -> execute flow and concurrency safety",
        "External tool compatibility is verified via the MCP interface",
        "Example: integration test performs a write that results in diff, commit, and log entry",
        "Negative case: direct filesystem write bypassing MCP fails the test suite"
      ],
      "startedAt": "2026-02-05T19:28:42.030872+00:00",
      "completedAt": "2026-02-05T19:40:21.498392+00:00",
      "updatedAt": "2026-02-05T19:40:21.498378+00:00"
    }
  ]
}
